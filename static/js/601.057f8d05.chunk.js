!function(){"use strict";var e={5601:function(e,t,n){var r=n(5861),a=n(7762),s=n(5671),u=n(3144),c=n(6296),o=n(7757),i=n.n(o),f=n(7557),h=n(5385),p=n.n(h),d=function(){function e(t){(0,s.Z)(this,e),this.db=void 0,this.db=(0,f.X3)(t,1,{upgrade:function(e,t,n,r){var s,u=e.objectStoreNames,c=(0,a.Z)(u);try{for(c.s();!(s=c.n()).done;){var o=s.value;e.deleteObjectStore(o)}}catch(f){c.e(f)}finally{c.f()}var i=e.createObjectStore("changes",{keyPath:"hash"});i.createIndex("docId","docId",{unique:!1}),i.createIndex("timestamp","timestamp",{unique:!1});e.createObjectStore("snapshots",{keyPath:"docId"})}})}return(0,u.Z)(e,[{key:"storeChange",value:function(){var e=(0,r.Z)(i().mark((function e(t,n,r){var a,s,u,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.db;case 2:return a=e.sent,s=a.transaction("changes","readwrite"),u=s.objectStore("changes"),e.next=7,u.get(n);case 7:if(!e.sent){e.next=9;break}return e.abrupt("return");case 9:return r.buffer.byteLength!==r.byteLength&&((c=new Uint8Array(r.byteLength)).set(r),r=c),e.next=12,a.add("changes",{docId:t,hash:n,change:r,timestamp:Date.now()});case 12:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"getChanges",value:function(){var e=(0,r.Z)(i().mark((function e(t){var n,r,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=IDBKeyRange.only(t),e.next=3,this.db;case 3:return r=e.sent,e.next=6,r.getAllFromIndex("changes","docId",n);case 6:return a=e.sent,e.abrupt("return",a.map((function(e){return e.change})));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getDoc",value:function(){var e=(0,r.Z)(i().mark((function e(t){var n,r,a,s,u,o,f,h,d,l,x,g,b,m,y,k,w,I;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.db;case 2:return n=e.sent,e.next=5,n.get("snapshots",t);case 5:r=e.sent,a=IDBKeyRange.only(t),s=[],u=0,o=!1,f=!1,e.prev=11,d=(0,c.Z)(n.transaction("changes").store.index("docId").iterate(a));case 13:return e.next=15,d.next();case 15:if(!(o=!(l=e.sent).done)){e.next=22;break}x=l.value,s.push(x.value.change),u=Math.max(x.value.timestamp,u);case 19:o=!1,e.next=13;break;case 22:e.next=28;break;case 24:e.prev=24,e.t0=e.catch(11),f=!0,h=e.t0;case 28:if(e.prev=28,e.prev=29,!o||null==d.return){e.next=33;break}return e.next=33,d.return();case 33:if(e.prev=33,!f){e.next=36;break}throw h;case 36:return e.finish(33);case 37:return e.finish(28);case 38:for(g=new Map,b=new Map,m=0,y=s;m<y.length;m++)k=y[m],w=p().decodeChange(k),b.set(w.hash,k),g.set(k,w);return I=v(s,(function(e){return g.get(e).deps.map((function(e){return b.get(e)}))})),e.abrupt("return",{serializedDoc:null===r||void 0===r?void 0:r.serializedDoc,changes:I,lastChangeTime:u});case 43:case"end":return e.stop()}}),e,this,[[11,24,28,38],[29,,33,37]])})));return function(t){return e.apply(this,arguments)}}()},{key:"saveSnapshot",value:function(){var e=(0,r.Z)(i().mark((function e(t){var n,r,a,s,u,c,o,f,h,d;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getDoc(t);case 2:if(n=e.sent,r=n.serializedDoc,a=n.changes,s=n.lastChangeTime,!(a.length<100)){e.next=8;break}return e.abrupt("return");case 8:return u=r?p().load(r):p().init(),u=p().applyChanges(u,a)[0],c=p().save(u),e.next=13,this.db;case 13:return o=e.sent,e.next=16,o.put("snapshots",{docId:t,serializedDoc:c,timestamp:Date.now()});case 16:return f=IDBKeyRange.upperBound(s),h=o.transaction("changes","readwrite").store.index("timestamp"),e.next=20,h.openCursor(f);case 20:d=e.sent;case 21:if(!d){e.next=28;break}return d.delete(),e.next=25,d.continue();case 25:d=e.sent,e.next=21;break;case 28:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();function v(e,t){for(var n=[],r=!0,s=new Set(e),u=new Set;s.size;){if(c(s.values().next().value),!r)throw new Error("Not a DAG")}return n;function c(e){if(s.has(e))if(u.has(e))r=!1;else{u.add(e);var o,i=(0,a.Z)(t(e));try{for(i.s();!(o=i.n()).done;){c(o.value)}}catch(f){i.e(f)}finally{i.f()}u.delete(e),s.delete(e),n.push(e)}}}var l=new d("autowiki");self.addEventListener("connect",(function(e){e.ports[0].onmessage=function(e){var t=e.data.docId;l.saveSnapshot(t)}}))}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var s=t[r]={exports:{}};return e[r].call(s.exports,s,s.exports,n),s.exports}n.m=e,n.x=function(){var e=n.O(void 0,[143],(function(){return n(5601)}));return e=n.O(e)},function(){var e=[];n.O=function(t,r,a,s){if(!r){var u=1/0;for(f=0;f<e.length;f++){r=e[f][0],a=e[f][1],s=e[f][2];for(var c=!0,o=0;o<r.length;o++)(!1&s||u>=s)&&Object.keys(n.O).every((function(e){return n.O[e](r[o])}))?r.splice(o--,1):(c=!1,s<u&&(u=s));if(c){e.splice(f--,1);var i=a();void 0!==i&&(t=i)}}return t}s=s||0;for(var f=e.length;f>0&&e[f-1][2]>s;f--)e[f]=e[f-1];e[f]=[r,a,s]}}(),n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,{a:t}),t},n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=function(e){return Promise.all(Object.keys(n.f).reduce((function(t,r){return n.f[r](e,t),t}),[]))},n.u=function(e){return"static/js/"+e+".9c404735.chunk.js"},n.miniCssF=function(e){},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",function(){var e={601:1};n.f.i=function(t,r){e[t]||importScripts(n.p+n.u(t))};var t=self.webpackChunkautowiki=self.webpackChunkautowiki||[],r=t.push.bind(t);t.push=function(t){var a=t[0],s=t[1],u=t[2];for(var c in s)n.o(s,c)&&(n.m[c]=s[c]);for(u&&u(n);a.length;)e[a.pop()]=1;r(t)}}(),function(){var e=n.x;n.x=function(){return n.e(143).then(e)}}();n.x()}();
//# sourceMappingURL=601.057f8d05.chunk.js.map