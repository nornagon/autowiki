{"version":3,"sources":["Replicate.tsx","PageText.tsx","export.ts","App.tsx","textarea-op.ts","serviceWorker.ts","index.tsx"],"names":["ReplicationPeer","doc","peer","onStateChange","stateChange","useRef","useEffect","current","protocol","window","location","exec","key","host","params","wsProvider","WebsocketProvider","lastState","setState","s","on","event","status","synced","destroy","e","alert","Replicate","peers","map","p","makeCheckboxesEnabled","tree","visit","type","tagName","properties","node","disabled","imageBlobReferences","getBlobURL","src","startsWith","split","pipeline","unified","use","markdown","highlight","wikiLink","hrefTemplate","link","pageResolver","name","wikiLinkClassName","remarkTruncateLinks","length","remark2rehype","allowDangerousHtml","handlers","code","h","value","lang","match","props","className","position","start","offset","u","inlineCode","replace","text","augment","String","raw","stringify","PageText","html","useMemo","processSync","toString","renderMarkdownToHtml","dangerouslySetInnerHTML","__html","extractLinks","parse","links","push","href","IMPORT_TRANSFORMERS","x","allPages","rootDoc","Y","gc","indexeddbProvider","IndexeddbPersistence","requestPersistentStorage","persistentStorageRequested","a","navigator","storage","persist","console","warn","getMap","keys","k","get","f","ExpandingTextArea","forwardRef","opts","ref","fnvHashInt32s","int32s","bytes","hash","Math","imul","fnvHash","Uint32Array","from","findNearestParent","fn","Element","parentElement","Page","title","useState","selected","setSelected","editing","setEditing","initial","has","v","transact","set","useReducer","forceUpdate","txn","observeDeep","unobserveDeep","useStorage","r","data","changeData","selectedEl","scrollIntoView","block","l","addEventListener","removeEventListener","preventDefault","requestAnimationFrame","textarea","setSelectionRange","blur","target","toArray","i","id","client","clock","mixedId","_item","lastId","padStart","expandedText","expandText","lookup","bannedTags","Set","tag","newBannedTags","add","join","onClick","nodeName","defaultPrevented","nextElementSibling","hasAttribute","d","pos","getAttribute","str","delete","insert","n","getSelection","anchorNode","anchorOffset","nearestPos","off","onClickBlock","substr","autoFocus","onKeyDown","currentTarget","selectionStart","selectionEnd","prev","prevLength","onChange","op","element","previous","end","slice","getInputEnd","charAt","removed","inserted","opFromInput","onPaste","clipboardData","items","item","mimeType","relStart","relEnd","getAsFile","arrayBuffer","buf","crypto","subtle","digest","digestStr","Uint8Array","blobs","absStart","absEnd","index","trim","MetaPage","page","rest","meta","Object","prototype","hasOwnProperty","call","MetaPages","all","filter","some","sort","b","localeCompare","style","width","height","objectFit","alt","export","document","createElement","setAttribute","Date","toISOString","exportObj","_autowiki","version","wiki","toJSON","fromEntries","entries","b64","exportData","JSON","blobURL","URL","createObjectURL","Blob","click","setTimeout","revokeObjectURL","input","onchange","files","then","json","TextDecoder","decode","formatError","exportFormatError","existingPages","added","replaced","newBlobs","warnStr","values","confirm","transformedData","reduce","transformer","existingPage","every","arr","blob","deserialize","blobURLs","Map","Backlinks","backlinks","backlinksByPage","backlinkingPages","encodeURIComponent","context","ReplicationStateIndicator","state","aggregateState","m","o","App","setSynced","whenSynced","pathname","setPathname","handlePopState","history","pushState","scrollTo","useHistory","navigate","localStorage","getItem","setPeers","peerState","setPeerState","pageTitle","decodeURIComponent","metaKey","ctrlKey","HTMLElement","toLowerCase","classList","contains","getBlocksLinkingTo","newPeerString","prompt","newPeers","setItem","Boolean","hostname","ReactDOM","render","getElementById","serviceWorker","ready","registration","unregister","catch","error","message"],"mappings":"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","file":"static/js/main.b7094819.chunk.js","sourcesContent":["import React, { useRef, useEffect } from 'react'\nimport { WebsocketProvider } from 'y-websocket';\nimport * as Y from 'yjs';\n\nexport type ReplicationState = 'offline' | 'synced' | 'behind'\n\nfunction ReplicationPeer({doc, peer, onStateChange}: {doc: Y.Doc, peer: string, onStateChange: (s: ReplicationState) => void}) {\n  const stateChange = useRef(onStateChange)\n  useEffect(() => { stateChange.current = onStateChange }, [onStateChange])\n  useEffect(() => {\n    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws'\n    const [, key, host] = /^(?:([^@]+)@)?(.+)$/.exec(peer)!\n    const params: Record<string, string> = key ? { key } : {}\n    try {\n      const wsProvider = new WebsocketProvider(`${protocol}://${host}`, 'autowiki', doc, { params })\n      let lastState: ReplicationState | null = null\n      function setState(s: ReplicationState) {\n        if (s !== lastState)\n          stateChange.current(s)\n        lastState = s\n      }\n      setState('offline')\n      wsProvider.on('status', (event: { status: 'connected' | 'disconnected' }) => {\n        if (event.status === 'connected') {\n          setState('behind')\n        } else if (event.status === 'disconnected') {\n          setState('offline')\n        }\n      })\n      wsProvider.on('sync', (synced: boolean) => {\n        if (!synced && lastState === 'synced') setState('behind')\n        if (synced) setState('synced')\n      })\n      return () => {\n        wsProvider.destroy()\n      }\n    } catch (e) {\n      alert(`Error connecting to replication peer: ${e}`)\n    }\n  }, [peer, doc])\n  return null\n}\n\nexport function Replicate({doc, peers, onStateChange}: {doc: Y.Doc, peers: string[], onStateChange: (peer: string, state: ReplicationState) => void}) {\n  return <>{peers.map(p => <ReplicationPeer doc={doc} peer={p} key={p} onStateChange={s => onStateChange(p, s)} />)}</>\n}","import React, { useMemo } from \"react\"\n\nimport markdown from 'remark-parse';\nimport remark2rehype from 'remark-rehype';\nimport highlight from 'remark-highlight.js';\nimport raw from 'rehype-raw';\nimport stringify from 'rehype-stringify';\nimport unified from 'unified';\nimport u from 'unist-builder'\nimport visit from 'unist-util-visit';\nimport wikiLink from 'remark-wiki-link';\nimport { remarkTruncateLinks } from 'remark-truncate-links';\nimport 'highlight.js/styles/github.css';\n\n\nfunction makeCheckboxesEnabled() {\n  return function(tree: any) {\n    visit(tree, ((e: any) => e.type === 'element' && e.tagName === 'input' && e.properties.type === 'checkbox') as any, (node) => {\n      delete (node as any).properties.disabled\n    })\n  }\n}\n\nfunction imageBlobReferences({getBlobURL}: {getBlobURL?: (hash: string) => string | undefined}) {\n  return function(tree: any) {\n    if (getBlobURL) {\n      visit(tree, ((e: any) => e.type === 'element' && e.tagName === 'img' && e.properties.src.startsWith('blob:')) as any, (node: any) => {\n        node.properties.src = getBlobURL(node.properties.src.split(':')[1])\n      })\n    }\n  }\n}\n\nfunction pipeline(getBlobURL?: (hash: string) => string | undefined) {\n  return unified()\n    .use(markdown)\n    .use(highlight)\n    .use(wikiLink, {\n      hrefTemplate: (link: string) => `/${link}`,\n      pageResolver: (name: string) => [name],\n      wikiLinkClassName: 'wikilink',\n    })\n    .use(remarkTruncateLinks, { length: 60 })\n    .use(remark2rehype, {\n      allowDangerousHtml: true,\n      handlers: {\n        code(h, node) {\n          var value = node.value ? node.value + '\\n' : ''\n          var lang = node.lang && (node.lang as any).match(/^[^ \\t]+(?=[ \\t]|$)/)\n          var props: any = {}\n\n          if (lang) {\n            props.className = ['language-' + lang]\n          }\n          props['x-pos'] = node.position!.start.offset! + 4 + (lang?.length ?? 0)\n\n          return h((node as any).position, 'pre', [h(node, 'code', props, [u('text', value)])])\n        },\n        inlineCode(h, node: any) {\n          var value = node.value.replace(/\\r?\\n|\\r/g, ' ')\n          return h(node, 'code', {'x-pos': node.position?.start.offset + 1}, [u('text', value)])\n        },\n        text(h, node) {\n          return h.augment(\n            node,\n            u('element',\n              {tagName: 'span', properties: {'x-pos': node.position?.start.offset}},\n              [u('text', String(node.value).replace(/[ \\t]*(\\r?\\n|\\r)[ \\t]*/g, '$1'))])\n          )\n        }\n      }\n    })\n    .use(makeCheckboxesEnabled)\n    .use(raw)\n    .use(imageBlobReferences, {getBlobURL})\n    .use(stringify)\n}\n\nfunction renderMarkdownToHtml(text: string, getBlobURL?: (hash: string) => string | undefined) {\n  return pipeline(getBlobURL)\n    .processSync(text)\n    .toString('utf8')\n}\n\nexport default function PageText({text, getBlobURL}: {text: string, getBlobURL?: (hash: string) => string | undefined}) {\n  const html = useMemo(() => {\n    return renderMarkdownToHtml(text, getBlobURL)\n  }, [text, getBlobURL])\n  return <div dangerouslySetInnerHTML={ { __html: html } } />\n}\n\nexport function extractLinks(text: string): any[] {\n  const tree = pipeline().parse(text)\n  const links: {href: string}[] = []\n  visit(tree, 'wikiLink', (node) => {\n    links.push({href: node.value as string})\n  })\n  return links\n}\n","import * as b64 from 'base64-arraybuffer';\nimport * as Y from 'yjs';\n\ntype Base64String = string\ntype ExportFormatV0 = {\n  _autowiki: { version: 1 },\n  wiki: Record<string, string[]>,\n  blobs: Record<string, {data: Base64String, type: string}>\n}\ntype ExportFormatV1 = {\n  _autowiki: { version: 2 }\n  wiki: Record<string, {blocks: Array<{text: string}>}>\n  blobs: Record<string, {data: Base64String, type: string}>\n}\nconst IMPORT_TRANSFORMERS = [\n  (x: any): ExportFormatV0 => x,\n  /*\n  (x: ExportFormatV0): ExportFormatV1 => ({\n    _autowiki: { ...x._autowiki, version: 2 },\n    //wiki: Object.fromEntries(Object.entries(x.wiki).map(([k, v]) => [k, {blocks: [{text: v}]}])),\n    blobs: x.blobs\n  }),\n  */\n] as const\n\ntype GetLength<original extends Readonly<any[]>> = original extends { length: infer L } ? L : never\ntype Prev<T extends number> = [-1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62][T];\ntype GetLast<original extends Readonly<any[]>> = original[Prev<GetLength<original>>]\n\ntype AssertEquals<A, B> = A extends B ? B extends A ? true : never : never;\ntype LatestExportFormat = ReturnType<GetLast<typeof IMPORT_TRANSFORMERS>>\ntype LatestExportVersion = LatestExportFormat[\"_autowiki\"][\"version\"]\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nconst staticAssert_lastVersionNumberEqualsLengthOfVersionTransformerArray: AssertEquals<LatestExportVersion, GetLength<typeof IMPORT_TRANSFORMERS>> = true\n\n// TODO: would be awesome if typescript could fill in the value here, as it's singly-occupied. https://www.npmjs.com/package/ts-reflection maybe?\nexport const EXPORT_VERSION: LatestExportVersion = 1\n\nexport const serialize = (doc: Y.Doc): LatestExportFormat => {\n  return {\n    _autowiki: { version: EXPORT_VERSION },\n    wiki: doc.getMap('wiki').toJSON(),\n    blobs: Object.fromEntries([\n      ...Object.entries(doc.getMap('blobs').toJSON())\n    ].map(([k, v]: [string, any]) => [k, {...v, data: b64.encode(v.data)}])),\n  }\n}\n\nexport const deserialize = (doc: Y.Doc, data: any) => {\n  const transformers = IMPORT_TRANSFORMERS.slice(data._autowiki.version)\n  const transformedData: LatestExportFormat = transformers.reduce((data, transformer) => transformer(data), data)\n\n  doc.transact(() => {\n    const wiki: Y.Map<Y.Array<Y.Text>> = doc.getMap('wiki')\n    for (const [page, data] of Object.entries(transformedData.wiki)) {\n      const existingPage = wiki.get(page)\n      if (existingPage?.length === data.length && existingPage?.toArray().every((x, i) => x.toString() === data[i]))\n        continue\n      const arr = new Y.Array<Y.Text>()\n      arr.push(data.map(str => new Y.Text(str)))\n      wiki.set(page, arr)\n    }\n    type BlobData = {data: Uint8Array, type: string}\n    const blobs: Y.Map<BlobData> = doc.getMap('blobs')\n    for (const [hash, blob] of Object.entries<any>(data.blobs)) {\n      if (blobs.has(hash))\n        continue\n      blobs.set(hash, {\n        ...blob,\n        data: new Uint8Array(b64.decode(blob.data))\n      })\n    }\n  })\n}\n\nexport const exportFormatError = (json: any): string | undefined => {\n  if (!json._autowiki) {\n    return \"That doesn't look like a valid Autowiki export.\"\n  }\n  if (json._autowiki.version > EXPORT_VERSION) {\n    return \"That file is too new for this version of Autowiki :(\"\n  }\n}\n","import React, { useEffect, useState, useMemo, useReducer, useRef, forwardRef } from 'react';\nimport './App.css';\nimport * as Y from 'yjs';\nimport { IndexeddbPersistence } from 'y-indexeddb'\nimport { opFromInput } from './textarea-op';\nimport { Replicate, ReplicationState } from './Replicate';\nimport PageText, { extractLinks } from './PageText';\nimport { deserialize, exportFormatError, serialize } from './export';\n\ntype Page = Y.Array<Y.Text>\n\nconst rootDoc = new Y.Doc()\nrootDoc.gc = false\n;(window as any).rootDoc = rootDoc\n\nconst indexeddbProvider = new IndexeddbPersistence('autowiki', rootDoc)\n\nconst useHistory = (): [string, (s: string) => void] => {\n  const [pathname, setPathname] = useState(window.location.pathname)\n  function handlePopState() {\n    setPathname(window.location.pathname)\n  }\n  function navigate(href: string) {\n    window.history.pushState(null, '', href)\n    setPathname(window.location.pathname)\n    window.scrollTo(0, 0)\n  }\n  useEffect(() => {\n    window.addEventListener('popstate', handlePopState)\n    return () => {\n      window.removeEventListener('popstate', handlePopState)\n    }\n  }, [])\n  return [pathname, navigate]\n}\n\nconst requestPersistentStorage = (() => {\n  let persistentStorageRequested = false\n  return async function requestPersistentStorage() {\n    if (!persistentStorageRequested) {\n      persistentStorageRequested = true\n      if (navigator.storage && navigator.storage.persist) {\n        const isPersisted = await navigator.storage.persist()\n        if (!isPersisted) {\n          // TODO: warn the user more clearly\n          console.warn(\"Navigator declined persistent storage\")\n        }\n      } else {\n        console.warn(\"Navigator does not support persistent storage\")\n      }\n    }\n  }\n})()\n\nfunction useStorage<T>(key: string, initial: () => T): [T, (f: (t: T) => void) => void] {\n  const map = rootDoc.getMap('wiki')\n  if (!map.has(key)) {\n    const v = initial()\n    rootDoc.transact(() => {\n      map.set(key, v)\n    })\n  }\n  function change(f: (t: T) => void) {\n    requestPersistentStorage()\n    rootDoc.transact(() => {\n      f(map.get(key))\n    })\n  }\n  const [, forceUpdate] = useReducer(x => x + 1, 0);\n  useEffect(() => {\n    const fn = (event: any, txn: Y.Transaction) => {\n      forceUpdate()\n    }\n    map.observeDeep(fn)\n    return () => {\n      map.unobserveDeep(fn)\n    }\n  })\n  return [map.get(key), change]\n}\n\nfunction* allPages(): Generator<[string, Page], any, unknown> {\n  const doc = rootDoc.getMap('wiki')\n  for (const k of doc.keys()) {\n    yield [k, doc.get(k)]\n  }\n}\n\nfunction ExpandingTextAreaUnforwarded(opts: React.DetailedHTMLProps<React.TextareaHTMLAttributes<HTMLTextAreaElement>, HTMLTextAreaElement>, ref: any) {\n  return (\n    <div className=\"expandingArea\">\n      <pre><span>{opts.value}</span><br/></pre>\n      <textarea {...opts} ref={ref}></textarea>\n    </div>\n  )\n}\nconst ExpandingTextArea = forwardRef(ExpandingTextAreaUnforwarded)\n\n// http://isthe.com/chongo/tech/comp/fnv/\n// FNV1a:\n// hash = offset_basis\n// for each octet_of_data to be hashed\n//   hash = hash xor octet_of_data\n//   hash = hash * FNV_prime\n// return hash\n// 32 bit FNV_prime = 224 + 28 + 0x93 = 16777619\n// 32 bit offset_basis = 2166136261\nfunction fnvHash(bytes: Iterable<number>): number {\n  const offset_basis = 2166136261\n  const FNV_prime = 16777619\n  let hash = offset_basis\n  for (const byte of bytes) {\n    hash = hash ^ byte\n    hash = Math.imul(hash, FNV_prime)\n  }\n  return hash >>> 0\n}\n\nfunction fnvHashInt32s(int32s: number[]): number {\n  return fnvHash(Uint32Array.from(int32s))\n}\n\nfunction mixedId(id: Y.ID): number {\n  return id ? fnvHashInt32s([id.client, id.clock]) : 0\n}\n\nfunction findNearestParent(node: Node, fn: (n: Element) => boolean): Element | null {\n  let e: Element | null = node instanceof Element ? node : node.parentElement\n  while (e && !fn(e)) {\n    e = e.parentElement\n  }\n  return e\n}\n\nfunction expandText(text: string, lookup: (tag: string) => string | undefined, bannedTags: Set<string> = new Set()): string {\n  return text.replace(/\\{\\{([^}]+?)\\}\\}/g, (match, tag) => {\n    if (bannedTags.has(tag)) return match\n    const newBannedTags = new Set(bannedTags)\n    newBannedTags.add(tag)\n    const text = lookup(tag)\n    return text ? expandText(text, lookup, newBannedTags) : match\n  })\n}\n\nfunction Page({title}: {title: string}) {\n  const [selected, setSelected] = useState(null as number | null)\n  const [editing, setEditing] = useState(false)\n  const [data, changeData] = useStorage<Y.Array<Y.Text>>(title, () => {\n    const r = new Y.Array<Y.Text>()\n    r.push([new Y.Text()])\n    return r\n  })\n  const selectedEl = useRef<HTMLDivElement>(null)\n\n  useEffect(() => {\n    if (selectedEl.current) {\n      selectedEl.current.scrollIntoView({block: \"nearest\"})\n    }\n  }, [selected])\n\n  useEffect(() => {\n    if (!editing) {\n      const l = (e: KeyboardEvent) => {\n        if (e.key === 'ArrowUp') {\n          if (selected === 0) setSelected(null)\n          else if (selected === null) setSelected(data.length - 1)\n          else setSelected(selected - 1)\n          e.preventDefault()\n        } else if (e.key === 'ArrowDown') {\n          if (selected === data.length - 1) setSelected(null)\n          else if (selected === null) setSelected(0)\n          else setSelected(selected + 1)\n          e.preventDefault()\n        } else if (e.key === 'Enter' && selected !== null) {\n          setEditing(true)\n          requestAnimationFrame(() => {\n            if (textarea.current) {\n              const length = textarea.current.value.length\n              textarea.current.setSelectionRange(length, length)\n            }\n          })\n          e.preventDefault()\n        } else if (e.key === 'Escape') {\n          setSelected(null)\n          e.preventDefault()\n        }\n      }\n      window.addEventListener('keydown', l)\n      return () => {\n        window.removeEventListener('keydown', l)\n      }\n    } else {\n      const l = (e: KeyboardEvent) => {\n        if (e.key === 'Escape') {\n          setEditing(false)\n        }\n      }\n      window.addEventListener('keydown', l)\n      return () => {\n        window.removeEventListener('keydown', l)\n      }\n    }\n  }, [selected, editing, data.length])\n\n  useEffect(() => {\n    function blur(e: MouseEvent) {\n      if (editing && textarea.current && e.target !== textarea.current) {\n        setEditing(false)\n        setSelected(null)\n      } else if (!editing && !findNearestParent(e.target as Element, e => e.className === 'Page')) {\n        setEditing(false)\n        setSelected(null)\n      }\n    }\n    window.addEventListener('mousedown', blur)\n    return () => {\n      window.removeEventListener('mousedown', blur)\n    }\n  }, [editing])\n  const textarea = useRef<HTMLTextAreaElement>(null)\n\n  function onClickBlock(e: React.MouseEvent<HTMLDivElement>, i: number) {\n    if (e.target instanceof Element && (e.target.nodeName === 'INPUT' || e.defaultPrevented)) {\n      const { nextElementSibling } = e.target\n      if (nextElementSibling && nextElementSibling.hasAttribute('x-pos')) {\n        changeData(d => {\n          // TODO: this is a hack, we should encode the source position of the checkbox during parsing\n          const text = d.get(i)\n          const pos = +nextElementSibling.getAttribute('x-pos')! - 3\n          const str = text.toString()\n          if (str[pos] === ' ') {\n            text.delete(pos, 1)\n            text.insert(pos, 'x')\n          } else if (str[pos] === 'x') {\n            text.delete(pos, 1)\n            text.insert(pos, ' ')\n          }\n        })\n      }\n      e.preventDefault()\n      return\n    }\n    if (e.target instanceof Element && (findNearestParent(e.target, n => n.nodeName === 'A') || e.target.nodeName === 'SUMMARY')) {\n      return\n    }\n    setSelected(i)\n    setEditing(true)\n    // anchorNode is the node in which the selection begins. (focusNode is where it ends.)\n    const { anchorNode, anchorOffset } = window.getSelection() ?? {}\n    if (anchorNode) {\n      const nearestPos = findNearestParent(anchorNode, e => e.hasAttribute('x-pos'))\n      if (nearestPos) {\n        const off = +(nearestPos.getAttribute('x-pos')!) + anchorOffset!\n        requestAnimationFrame(() => {\n          textarea.current?.setSelectionRange(off, off)\n        })\n      }\n    }\n  }\n\n  return <article className=\"Page\">\n    <h1>{title}</h1>\n    {data.toArray().map((text, i) => {\n      const idNum = mixedId(text._item?.lastId ?? {client: 0, clock: 0})\n      const id = idNum.toString(16).padStart(8, '0')\n      const expandedText = expandText(\n        text.toString(),\n        (tag) => rootDoc.getMap('wiki').get(tag)?.map((block: Y.Text) => block.toString()).join(\"\\n\\n\")\n      )\n      return <div className={`para ${selected === i ? \"selected\" : \"\"}`} ref={selected === i ? selectedEl : null} onClick={e => onClickBlock(e, i)}>\n        <div className=\"id\"><a id={id} href={`#${id}`} title={id}>{id?.substr(0, 3) ?? ''}</a></div>\n        {editing && selected === i\n        ? <ExpandingTextArea\n            ref={textarea}\n            value={text.toString()}\n            autoFocus\n            onKeyDown={e => {\n              const { currentTarget } = e\n              const { selectionStart, selectionEnd } = currentTarget\n              if (e.key === 'Backspace' && selectionStart === 0 && selectionEnd === 0 && selected > 0) {\n                // merge paras\n                changeData(d => {\n                  const prev = d.get(selected - 1)\n                  const prevLength = prev.length\n                  prev.insert(prev.length, d.get(selected).toString())\n                  d.delete(selected, 1)\n                  requestAnimationFrame(() => {\n                    textarea.current?.setSelectionRange(prevLength, prevLength)\n                  })\n                })\n                setSelected(selected - 1)\n              }\n              if (e.key === '[') {\n                changeData(d => {\n                  d.get(selected).insert(selectionEnd, ']')\n                  d.get(selected).insert(selectionStart, '[')\n                })\n                requestAnimationFrame(() => currentTarget.setSelectionRange(selectionStart + 1, selectionEnd + 1))\n                e.preventDefault()\n              } else if (e.key === ']' && selectionStart === selectionEnd && currentTarget.value[selectionStart] === ']') {\n                e.preventDefault()\n                currentTarget.setSelectionRange(selectionStart + 1, selectionStart + 1)\n              }\n            }}\n            onChange={e => {\n              const op = opFromInput(e.target, text?.toString() ?? '')\n              if (op && op.inserted === '\\n' && op.removed == null && e.target.value.substr(op.start - 1, 2) === '\\n\\n') {\n                changeData(d => {\n                  //const str = d[selected].toString().substr(op.start);\n                  const str = d.get(selected).toString().substr(op.start, d.get(selected).length - op.start + 1)\n                  d.get(selected).delete(op.start - 1, d.get(selected).length - op.start + 1)\n                  d.insert(selected + 1, [new Y.Text(str)])\n                })\n                setSelected(selected + 1)\n                return\n              }\n              if (op) {\n                changeData(d => {\n                  const {start, removed, inserted} = op\n                  if (removed != null) {\n                    d.get(selected).delete(start, removed.length)\n                  }\n                  if (inserted != null) {\n                    d.get(selected).insert(start, inserted)\n                  }\n                })\n              }\n            }}\n            onPaste={e => {\n              const { currentTarget } = e\n              const { selectionStart, selectionEnd } = currentTarget\n              for (const item of e.clipboardData.items) {\n                const mimeType = item.type\n                if (mimeType.startsWith('image/')) {\n                  e.preventDefault()\n                  changeData(d => {\n                    const text = d.get(selected)\n                    if (selectionEnd !== selectionStart)\n                      text.delete(selectionStart, selectionEnd - selectionStart)\n                    text.insert(selectionStart, '![](...)')\n                  })\n                  const relStart = Y.createRelativePositionFromTypeIndex(data.get(selected), selectionStart + 4)\n                  const relEnd = Y.createRelativePositionFromTypeIndex(data.get(selected), selectionStart + 7)\n                  ;(async () => {\n                    const buf = await (item.getAsFile() as any).arrayBuffer()\n                    const digest = await crypto.subtle.digest('SHA-256', buf!)\n                    const digestStr = [...new Uint8Array(digest)].map(x => x.toString(16).padStart(2, '0')).join('')\n                    const blobs = rootDoc.getMap('blobs')\n                    rootDoc.transact(() => {\n                      if (!blobs.has(digestStr)) {\n                        blobs.set(digestStr, {data: new Uint8Array(buf), type: mimeType})\n                      }\n                      const text = data.get(selected)\n                      const absStart = Y.createAbsolutePositionFromRelativePosition(relStart, rootDoc)\n                      const absEnd = Y.createAbsolutePositionFromRelativePosition(relEnd, rootDoc)\n                      if (absStart && absEnd) {\n                        text.delete(absStart.index, absEnd.index - absStart.index)\n                        text.insert(absStart.index, `blob:${digestStr}`)\n                      }\n                    })\n                  })()\n                  break;\n                }\n              }\n            }}\n            />\n        : text.toString()?.trim()\n        ? <PageText\n            text={expandedText}\n            getBlobURL={getBlobURL} />\n        : '\\u00a0'}\n      </div>\n    })}\n  </article>\n}\n\nfunction isValidMetaPage(x: any): x is keyof typeof MetaPages {\n  return Object.prototype.hasOwnProperty.call(MetaPages, x)\n}\n\nfunction MetaPage({page, ...rest}: {page: string}) {\n  const [, meta] = /^meta:(.+)$/.exec(page) ?? []\n  if (isValidMetaPage(meta)) {\n    const Page = MetaPages[meta]\n    return <Page {...rest} />\n  } else {\n    return <>Unknown 'meta' page: {meta}</>\n  }\n}\n\nconst MetaPages = {\n  all: () => {\n    return <div className=\"Page\">\n      <h1>All Pages</h1>\n      <ul>\n        {[...allPages()].filter(x => x[1].toArray().some(x => x.length > 0)).sort((a, b) => a[0].localeCompare(b[0])).map(([title, page]) => {\n          return <li><a href={`/${title}`} className=\"wikilink\">{title || '/'}</a></li>\n        })}\n      </ul>\n    </div>\n  },\n  blobs: () => {\n    return <div className=\"Page\">\n      <h1>Blobs</h1>\n      <ul>\n        {[...rootDoc.getMap(\"blobs\").keys()].map(hash => {\n          return <li><img src={getBlobURL(hash)} style={{width: 256, height: 256, objectFit: 'cover'}} alt={hash}/></li>\n        })}\n      </ul>\n    </div>\n  },\n  export: () => {\n    function doImport() {\n      const input = document.createElement('input')\n      input.setAttribute('type', 'file')\n      input.setAttribute('hidden', 'hidden')\n      input.onchange = (e) => {\n        if (input.files?.length) {\n          (input.files[0] as any).arrayBuffer().then((buf: ArrayBuffer) => {\n            let json: any = null\n            try {\n              const str = (new TextDecoder()).decode(buf)\n              json = JSON.parse(str)\n            } catch (e) {\n              alert(\"That doesn't look like a valid Autowiki export (not valid JSON).\")\n              return\n            }\n            const formatError = exportFormatError(json)\n            if (formatError) {\n              alert(formatError)\n              return\n            }\n\n            const existingPages = new Set(rootDoc.getMap('wiki').keys())\n            const added = Object.keys(json.wiki).filter(k => !existingPages.has(k))\n            const replaced = Object.keys(json.wiki).filter(k => existingPages.has(k))\n            const blobs = rootDoc.getMap('blobs')\n            const newBlobs = Object.keys(json.blobs).filter(k => !blobs.has(k))\n            const warn = [\n              {name: 'new page', values: added},\n              {name: 'replaced page', values: replaced},\n              {name: 'new blob', values: newBlobs}\n            ]\n            const warnStr = `This import contains ${warn.map(({name, values}) => `${values.length} ${name}${values.length === 1 ? '' : 's'}`).join(', ')}. Go ahead?`\n            if (!window.confirm(warnStr)) {\n              alert('Import cancelled.')\n              return\n            }\n            deserialize(rootDoc, json)\n            alert('Import complete.')\n          })\n        }\n      }\n      input.click()\n    }\n    function doExport() {\n      const a = document.createElement('a')\n      a.setAttribute('download', `autowiki-export-${(new Date().toISOString())}.json`)\n      const exportObj = serialize(rootDoc)\n      const exportData = JSON.stringify(exportObj)\n      const blobURL = URL.createObjectURL(new Blob([exportData], {type: 'application/json'}))\n      a.setAttribute('href', blobURL)\n      a.click()\n      setTimeout(() => {\n        URL.revokeObjectURL(blobURL)\n      }, 10000)\n    }\n    return <div className=\"Page\">\n      <h1>Export/Import</h1>\n      <p>\n        <button onClick={doExport}>export</button>\n      </p>\n      <p>\n        <button onClick={doImport}>import</button>\n      </p>\n    </div>\n  }\n}\n\nconst blobURLs = new Map<string, string>()\nfunction getBlobURL(hash: string): string | undefined {\n  if (!blobURLs.has(hash)) {\n    const blob = rootDoc.getMap('blobs').get(hash)\n    if (blob && blob.data instanceof Uint8Array) {\n      const data = blob.data\n      const type = blob.type\n      blobURLs.set(hash, URL.createObjectURL(new Blob([data], { type })))\n    }\n  }\n  return blobURLs.get(hash)\n}\n\nfunction Backlinks({backlinks}: {backlinks: LinkInfo[]}) {\n  const backlinksByPage = useMemo(() => {\n    const backlinksByPage = new Map<string, LinkInfo[]>()\n    for (const l of backlinks) {\n      if (!backlinksByPage.has(l.page)) {\n        backlinksByPage.set(l.page, [])\n      }\n      backlinksByPage.get(l.page)!.push(l)\n    }\n    return backlinksByPage\n  }, [backlinks])\n  const backlinkingPages = [...backlinksByPage.keys()].sort()\n  return <article className=\"Page\">\n    <h4>References</h4>\n    {backlinkingPages.length === 0 ? <p><em>No pages link here.</em></p> : null}\n    <ul>\n      {backlinkingPages.map(page => <li key={page}>\n        <a href={page ? encodeURIComponent(page) : \"/\"} className=\"wikilink\">{page || \"/\"}</a>:\n        <ul>{backlinksByPage.get(page)!.map((l, i) => <li key={i}><PageText text={l.context} /></li>)}</ul>\n      </li>)}\n    </ul>\n  </article>\n}\n\ntype LinkInfo = {page: string, context: string}\n\nfunction getBlocksLinkingTo(pageTitle: string): LinkInfo[] {\n  const links: LinkInfo[] = []\n  for (const [k, v] of allPages()) {\n    if (k === pageTitle) continue\n    for (const block of v) {\n      for (const link of extractLinks(block.toString())) {\n        if (link.href === pageTitle)\n          links.push({page: k, context: block.toString()})\n      }\n    }\n  }\n  return links\n}\n\nfunction useDocumentTitle(title: string) {\n  useEffect(() => {\n    document.title = title;\n  }, [title])\n}\n\nfunction ReplicationStateIndicator({state, onClick}: {state: Record<string, ReplicationState>, onClick?: React.MouseEventHandler<HTMLDivElement>}) {\n  const aggregateState = Object.values(state).reduce((m, o) => {\n    if (m === 'offline') {\n      return o !== 'offline' ? o : m\n    } else if (m === 'behind') {\n      return 'behind'\n    } else if (m === 'synced') {\n      return o === 'behind' ? o : m\n    }\n    return m\n  }, 'offline' as ReplicationState)\n  return <div className={`ReplicationStateIndicator ${aggregateState}`} onClick={onClick}>\n    <div className=\"bubble\" />\n  </div>\n}\n\nfunction App() {\n  const [synced, setSynced] = useState(false)\n  useEffect(() => {\n    indexeddbProvider.whenSynced.then(() => {\n      setSynced(true)\n    })\n  }, [])\n  const [pathname, navigate] = useHistory()\n  const [peers, setPeers] = useState<string[]>(() => JSON.parse(localStorage.getItem('peers') ?? '[]'))\n  const [peerState, setPeerState] = useState<Record<string, ReplicationState>>({})\n  const pageTitle = decodeURIComponent(pathname.substr(1))\n  useDocumentTitle(pageTitle)\n\n  useEffect(() => {\n    function onClick(e: MouseEvent) {\n      if (!(e.metaKey || e.ctrlKey) && e.target instanceof HTMLElement && e.target.tagName.toLowerCase() === 'a' && e.target.classList.contains('wikilink')) {\n        const target = e.target.getAttribute('href')\n        if (target) {\n          navigate(target)\n          e.preventDefault()\n          return\n        }\n      }\n    }\n    window.addEventListener('click', onClick)\n    return () => {\n      window.removeEventListener('click', onClick)\n    }\n  }, [navigate])\n\n  // TODO: this also depends on the other docs, but for now let's only recalculate it when you navigate.\n  const backlinks = useMemo(() => getBlocksLinkingTo(pageTitle), [pageTitle, synced])\n  if (!synced) return <>Loading...</>\n\n  return <>\n    <Replicate doc={rootDoc} peers={peers} onStateChange={(peer, state) => { setPeerState(s => ({...s, [peer]: state})) }} />\n    {pageTitle.startsWith('meta:') ? <MetaPage page={pageTitle} /> : <>\n      <Page key={pageTitle} title={pageTitle} />\n      <Backlinks backlinks={backlinks} />\n    </>}\n    <ReplicationStateIndicator state={peerState} onClick={() => {\n      const newPeerString = prompt(\"Peers?\", peers.join(','))\n      if (newPeerString) {\n        const newPeers = newPeerString.split(',').map(x => x.trim()).filter(x => x)\n        setPeers(newPeers)\n        localStorage.setItem('peers', JSON.stringify(newPeers))\n      }\n    }} />\n  </>;\n}\n\nexport default App;\n","\nfunction getInputEnd(element: HTMLTextAreaElement, previous: string, value: string): number | null {\n  var end = value.length - element.selectionStart;\n  if (end === 0) return end;\n  if (previous.slice(previous.length - end) !== value.slice(value.length - end)) return null;\n  return end;\n};\n\ntype Op = {\n  start: number, inserted?: string, removed?: string\n}\n\nexport function opFromInput(element: HTMLTextAreaElement, previous: string): Op | null {\n  var value = element.value;\n  if (previous === value) return null;\n\n  var start = 0;\n  // Attempt to use the DOM cursor position to find the end\n  var end = getInputEnd(element, previous, value);\n  if (end === null) {\n    // If we failed to find the end based on the cursor, do a diff. When\n    // ambiguous, prefer to locate ops at the end of the string, since users\n    // more frequently add or remove from the end of a text input\n    while (previous.charAt(start) === value.charAt(start)) {\n      start++;\n    }\n    end = 0;\n    while (\n      previous.charAt(previous.length - 1 - end) === value.charAt(value.length - 1 - end) &&\n      end + start < previous.length &&\n      end + start < value.length\n    ) {\n      end++;\n    }\n  } else {\n    while (\n      previous.charAt(start) === value.charAt(start) &&\n      start + end < previous.length &&\n      start + end < value.length\n    ) {\n      start++;\n    }\n  }\n\n  const op: Op = { start }\n  if (previous.length !== start + end) {\n    var removed = previous.slice(start, previous.length - end);\n    op.removed = removed\n  }\n  if (value.length !== start + end) {\n    var inserted = value.slice(start, value.length - end);\n    op.inserted = inserted\n  }\n  return op\n}\n\n/*\nTextDiffBinding.prototype.onInsert = function(index, length) {\n  this._transformSelectionAndUpdate(index, length, insertCursorTransform);\n};\nfunction insertCursorTransform(index, length, cursor) {\n  return (index < cursor) ? cursor + length : cursor;\n}\n\nTextDiffBinding.prototype.onRemove = function(index, length) {\n  this._transformSelectionAndUpdate(index, length, removeCursorTransform);\n};\nfunction removeCursorTransform(index, length, cursor) {\n  return (index < cursor) ? cursor - Math.min(length, cursor - index) : cursor;\n}\n\nTextDiffBinding.prototype._transformSelectionAndUpdate = function(index, length, transformCursor) {\n  if (document.activeElement === this.element) {\n    var selectionStart = transformCursor(index, length, this.element.selectionStart);\n    var selectionEnd = transformCursor(index, length, this.element.selectionEnd);\n    var selectionDirection = this.element.selectionDirection;\n    this.update();\n    this.element.setSelectionRange(selectionStart, selectionEnd, selectionDirection);\n  } else {\n    this.update();\n  }\n};\n\nTextDiffBinding.prototype.update = function() {\n  var value = this._get();\n  if (this._getElementValue() === value) return;\n  this.element.value = value;\n};\n*/","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      process.env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' }\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(<App />, document.getElementById('root'));\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n"],"sourceRoot":""}